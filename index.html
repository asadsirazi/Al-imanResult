<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>আল-ঈমান আদর্শ মহিলা আলিম মাদ্রাসা - অনলাইন রেজাল্ট পোর্টাল</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://aliman.lovable.app/assets/logo-BqvBHxy4.png">

    <!-- SolaimanLipi Font -->
    <link href="https://fonts.maateen.me/solaiman-lipi/font.css" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Html2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        body {
            font-family: 'SolaimanLipi', sans-serif;
            background-color: #f0fdf4;
            transition: all 0.3s ease;
        }
        .marksheet-border {
            border: 6px double #065f46;
            background-color: #fff;
            position: relative;
            margin: 0 auto;
        }
        .main-table th {
            background-color: #065f46;
            color: white;
            border: 1px solid #064e3b;
            padding: 8px;
            font-size: 16px;
        }
        .main-table td {
            border: 1px solid #065f46;
            padding: 6px;
            text-align: center;
            font-size: 16px;
        }
        
        .decorative-line {
            height: 2px;
            background: linear-gradient(to right, transparent, #065f46, transparent);
            margin: 20px auto;
            width: 80%;
        }

        /* A4 Download Mode */
        .a4-download-mode {
            width: 800px !important;
            min-height: 1120px;
            padding: 40px !important;
        }

        @media print {
            .no-print { display: none; }
            body { background: white; padding: 0; }
            .marksheet-border { border: 4px solid #065f46; padding: 20px; width: 100% !important; box-shadow: none; }
        }

        /* Loader Animation */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #065f46;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
            display: inline-block;
            vertical-align: middle;
            margin-left: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Landing Page (Static Fallback Information) -->
    <div id="landingPage" class="flex flex-col items-center justify-center min-h-screen px-4 py-10">
        <div class="max-w-2xl w-full bg-white p-8 rounded-3xl shadow-2xl text-center border-t-8 border-emerald-800">
            <img src="https://aliman.lovable.app/assets/logo-BqvBHxy4.png" alt="Madrasa Logo" class="h-24 mx-auto mb-4">
            
            <h1 class="text-3xl md:text-4xl font-bold text-emerald-900 leading-tight">আল-ঈমান আদর্শ মহিলা আলিম মাদ্রাসা</h1>
            <p class="text-gray-600 font-semibold mt-2">উত্তর ঝাপুয়া, কালারমারছড়া, মহেশখালী, কক্সবাজার</p>
            <div class="flex flex-wrap justify-center gap-4 text-emerald-700 font-bold mt-1">
                <p>স্থাপিত : ২০০৫</p>
                <p>EIIN : 138140</p>
            </div>
            
            <div class="decorative-line"></div>
            
            <h2 class="text-4xl md:text-5xl font-black text-emerald-800 mt-4 mb-2 uppercase">রেজাল্ট পোর্টাল ২০২৫</h2>
            <h3 class="text-xl font-bold text-emerald-600 mb-8">বার্ষিক পরীক্ষা - ২০২৫</h3>

            <!-- Search Form -->
            <div class="space-y-4 max-w-sm mx-auto text-left">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">শ্রেণী নির্বাচন করুন</label>
                    <select id="classSelect" class="w-full p-3 border-2 border-emerald-100 rounded-xl outline-none focus:border-emerald-600 bg-emerald-50">
                        <option value="0">নার্সারি/শিশু</option>
                        <option value="1">নূরানী প্রথম</option>
                        <option value="2">নূরানী দ্বিতীয়</option>
                        <option value="3">ইবতেদায়ী তৃতীয়</option>
                        <option value="4">ইবতেদায়ী চতুর্থ</option>
                        <option value="5">ইবতেদায়ী পঞ্চম</option>
                        <option value="5b">ইবতেদায়ী পঞ্চম (বালক)</option>
                        <option value="6">দাখিল ষষ্ঠ</option>
                        <option value="6b">দাখিল ষষ্ঠ (বালক)</option>
                        <option value="7">দাখিল সপ্তম</option>
                        <option value="7b">দাখিল সপ্তম (বালক)</option>
                        <option value="8">দাখিল অষ্টম</option>
                        <option value="8b">দাখিল অষ্টম (বালক)</option>
                        <option value="9">দাখিল নবম</option>
                        <option value="10">দাখিল দশম</option>
                        <option value="H">হিফজ বিভাগ</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">রোল নাম্বার লিখুন</label>
                    <input type="number" id="rollInput" placeholder="উদা: ১০০১" class="w-full p-3 border-2 border-emerald-100 rounded-xl outline-none focus:border-emerald-600 bg-emerald-50">
                </div>
                <button onclick="getResult()" id="searchBtn" class="w-full bg-emerald-800 text-white font-bold py-4 rounded-xl hover:bg-emerald-900 transition-all shadow-xl text-xl flex items-center justify-center text-center">
                    <span id="btnText">ফলাফল দেখুন</span>
                    <span id="loadingIcon" class="loader hidden"></span>
                </button>
            </div>
        </div>
    </div>

    <!-- Transcript Page -->
    <div id="resultPage" class="hidden min-h-screen py-10 px-2 md:px-4">
        <div id="captureArea" class="max-w-4xl mx-auto marksheet-border p-4 md:p-10 shadow-2xl overflow-hidden bg-white">
            
            <div class="absolute inset-0 flex items-center justify-center opacity-[0.03] pointer-events-none">
                <img id="watermarkLogo" src="" class="w-2/3 rotate-12">
            </div>

            <!-- Header -->
            <div class="flex flex-col md:flex-row justify-between items-center md:items-start mb-6 relative z-10 text-center md:text-left">
                <div class="w-24 mb-4 md:mb-0">
                    <img id="transcriptLogo" src="" alt="Logo" class="mx-auto">
                </div>
                
                <div class="flex-1 px-4 text-center">
                    <h1 id="transcriptInstName" class="text-2xl md:text-3xl font-bold text-emerald-900 leading-tight">আল-ঈমান আদর্শ মহিলা আলিম মাদ্রাসা</h1>
                    <p id="transcriptAddress" class="text-xs md:text-sm font-semibold text-gray-600 mt-1">উত্তর ঝাপুয়া, কালারমারছড়া, মহেশখালী, কক্সবাজার</p>
                    <div class="flex justify-center gap-2 text-[10px] md:text-xs font-bold text-emerald-700">
                        <p id="transcriptEst">স্থাপিত : ২০০৫</p>
                        <p id="transcriptEiin">EIIN : 138140</p>
                    </div>
                    <div class="mt-4 bg-emerald-800 text-white inline-block px-6 py-1 rounded text-lg font-bold text-center">
                        <span id="transcriptLabel">একাডেমিক ট্রান্সক্রিপ্ট</span>
                    </div>
                    <p id="transcriptExamName" class="font-bold mt-1 text-emerald-900">বার্ষিক পরীক্ষা - ২০২৫</p>
                </div>

                <div class="w-32 hidden md:block border border-gray-300">
                    <table class="w-full text-[9px] text-center">
                        <tr class="bg-gray-100 border-b"><th>নম্বর</th><th>গ্রেড</th><th>পয়েন্ট</th></tr>
                        <tr><td>৮০-১০০</td><td>A+</td><td>5.00</td></tr>
                        <tr><td>৭০-৭৯</td><td>A</td><td>4.00</td></tr>
                        <tr><td>৬০-৬৯</td><td>A-</td><td>3.50</td></tr>
                        <tr><td>৫০-৫৯</td><td>B</td><td>3.00</td></tr>
                        <tr><td>৪০-৪৯</td><td>C</td><td>2.00</td></tr>
                        <tr><td>৩৩-৩৯</td><td>D</td><td>1.00</td></tr>
                        <tr><td>০-৩২</td><td>F</td><td>0.00</td></tr>
                    </table>
                </div>
            </div>

            <!-- Student Info (New Layout) -->
            <div class="mb-8 relative z-10">
                <div class="text-center mb-6">
                    <h2 id="st_name" class="text-3xl md:text-5xl font-extrabold text-emerald-900 border-b-4 border-emerald-50 pb-2 inline-block px-10"></h2>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-4">
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                            <span class="font-bold text-emerald-900 text-sm md:text-lg">পিতার নাম</span>
                            <span id="st_father" class="text-gray-800 font-semibold text-right text-sm md:text-lg"></span>
                        </div>
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                            <span class="font-bold text-emerald-900 text-sm md:text-lg">মাতার নাম</span>
                            <span id="st_mother" class="text-gray-800 font-semibold text-right text-sm md:text-lg"></span>
                        </div>
                    </div>
                    <div class="space-y-3">
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                            <span class="font-bold text-emerald-900 text-sm md:text-lg">শ্রেণী</span>
                            <span id="st_class" class="text-gray-800 font-semibold text-right text-sm md:text-lg"></span>
                        </div>
                        <div class="flex justify-between items-center border-b border-gray-100 pb-1">
                            <span class="font-bold text-emerald-900 text-sm md:text-lg">রোল নম্বর</span>
                            <span id="st_roll" class="font-extrabold text-emerald-900 text-right text-sm md:text-lg"></span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Marks Table -->
            <div class="overflow-x-auto mb-6 relative z-10">
                <table class="w-full main-table min-w-[500px] md:min-w-full">
                    <thead>
                        <tr>
                            <th class="w-1/2">বিষয়ের নাম</th>
                            <th>প্রাপ্ত নম্বর</th>
                            <th>গ্রেড</th>
                            <th>পয়েন্ট</th>
                        </tr>
                    </thead>
                    <tbody id="marksBody" class="font-medium text-gray-800"></tbody>
                </table>
            </div>

            <!-- Summary -->
            <div class="flex flex-col md:flex-row justify-between items-start gap-4 mb-6 relative z-10">
                <div class="w-full md:w-1/2 border border-emerald-800 rounded overflow-hidden">
                    <table class="w-full text-md">
                        <tr class="border-b border-emerald-800">
                            <td class="p-2 bg-emerald-50 font-bold text-emerald-900 text-lg">মোট নম্বর</td>
                            <td class="p-2 text-center font-bold text-xl" id="sm_total"></td>
                        </tr>
                        <tr class="border-b border-emerald-800">
                            <td class="p-2 bg-emerald-50 font-bold text-emerald-900 text-lg">গড় নম্বর</td>
                            <td class="p-2 text-center font-bold text-xl" id="sm_avg"></td>
                        </tr>
                        <tr>
                            <td class="p-2 bg-emerald-50 font-bold text-emerald-900 text-lg uppercase">GPA</td>
                            <td class="p-2 text-center font-black text-3xl text-emerald-900" id="sm_gpa"></td>
                        </tr>
                    </table>
                </div>
                
                <div class="w-full md:w-1/3 flex flex-row md:flex-col gap-2">
                    <div class="flex-1 border-2 border-emerald-800 p-3 text-center rounded bg-emerald-50">
                        <p class="text-xs font-bold text-emerald-900 uppercase text-center">মেধাক্রম</p>
                        <p id="sm_pos" class="text-2xl font-black text-emerald-800 text-center"></p>
                    </div>
                    <div class="flex-1 border-2 border-emerald-800 p-3 text-center rounded bg-emerald-50">
                        <p class="text-xs font-bold text-emerald-900 uppercase text-center">চূড়ান্ত গ্রেড</p>
                        <p id="sm_grade" class="text-2xl font-black text-emerald-800 text-center"></p>
                    </div>
                </div>
            </div>

            <!-- Footer -->
            <div class="mt-20 flex justify-between items-end px-2 relative z-10">
                <div class="text-center w-1/3"><div class="border-t border-emerald-900 pt-1 text-[10px] font-bold">অভিভাবকের স্বাক্ষর</div></div>
                <div class="text-center w-1/3"><div class="border-t border-emerald-900 pt-1 text-[10px] font-bold">শ্রেণী শিক্ষকের স্বাক্ষর</div></div>
                <div class="text-center w-1/3"><div id="principalLabel" class="border-t border-emerald-900 pt-1 font-bold text-sm">অধ্যক্ষ / প্রধান শিক্ষক</div></div>
            </div>
        </div>

        <!-- Buttons -->
        <div class="max-w-4xl mx-auto mt-10 flex flex-wrap justify-center gap-4 no-print pb-20">
            <button onclick="goBack()" class="bg-gray-600 text-white px-8 py-3 rounded-full shadow-lg font-bold hover:bg-gray-700 transition">আবার খুঁজুন</button>
            <button onclick="downloadJPG()" class="bg-blue-600 text-white px-8 py-3 rounded-full shadow-lg font-bold hover:bg-blue-700 transition">JPG ডাউনলোড</button>
            <button onclick="window.print()" class="bg-emerald-900 text-white px-8 py-3 rounded-full shadow-lg font-bold hover:bg-black transition text-center">প্রিন্ট / PDF</button>
        </div>
    </div>

    <script>
        const DEFAULT_CONFIG = {
            "Institute Name": "আল-ঈমান আদর্শ মহিলা আলিম মাদ্রাসা",
            "Logo Link": "https://aliman.lovable.app/assets/logo-BqvBHxy4.png",
            "Address": "উত্তর ঝাপুয়া, কালারমারছড়া, মহেশখালী, কক্সবাজার",
            "স্থাপিত": "স্থাপিত : ২০০৫",
            "EIIN": "EIIN : 138140",
            "Examination Name": "বার্ষিক পরীক্ষা - ২০২৫",
            "Principle Bangla": "অধ্যক্ষ",
            "Academic Transcript Bangla": "একাডেমিক ট্রান্সক্রিপ্ট"
        };

        const API_URL = "https://script.google.com/macros/s/AKfycbxLEcOkZHy3hxk1QKnu-zEWqVgjlbQL4ndR0lsRKb25GddSl3Wjw_nH2F6dV7yfyBZudA/exec";
        let currentStudent = "Result";

        window.onload = function() {
            loadInfoFromSheet();
        };

        async function loadInfoFromSheet() {
            try {
                const response = await fetch(`${API_URL}?action=info`);
                const infoData = await response.json();
                if (infoData && !infoData.error) {
                    updateResultPageInfo(infoData);
                } else {
                    updateResultPageInfo(DEFAULT_CONFIG);
                }
            } catch (err) {
                updateResultPageInfo(DEFAULT_CONFIG);
            }
        }

        function updateResultPageInfo(config) {
            const getVal = (key) => {
                if(config[key]) return config[key].status === "No" ? "" : config[key].val || config[key];
                return DEFAULT_CONFIG[key];
            };

            const logoUrl = getVal("Logo Link");
            if (logoUrl) {
                document.getElementById('transcriptLogo').src = logoUrl;
                document.getElementById('watermarkLogo').src = logoUrl;
            }

            document.getElementById('transcriptInstName').innerText = getVal("Institute Name");
            document.getElementById('transcriptAddress').innerText = getVal("Address");
            document.getElementById('transcriptEst').innerText = getVal("স্থাপিত");
            document.getElementById('transcriptEiin').innerText = getVal("EIIN");
            document.getElementById('transcriptExamName').innerText = getVal("Examination Name");
            document.getElementById('transcriptLabel').innerText = getVal("Academic Transcript Bangla");
            document.getElementById('principalLabel').innerText = getVal("Principle Bangla") + " / প্রধান শিক্ষক";
        }

        async function getResult() {
            const className = document.getElementById('classSelect').value;
            const roll = document.getElementById('rollInput').value;
            const btnText = document.getElementById('btnText');
            const loadingIcon = document.getElementById('loadingIcon');
            const searchBtn = document.getElementById('searchBtn');

            if(!roll) { alert("দয়া করে রোল নাম্বার দিন"); return; }
            
            btnText.innerText = "লোডিং হচ্ছে...";
            loadingIcon.classList.remove('hidden');
            searchBtn.disabled = true;

            try {
                const response = await fetch(`${API_URL}?className=${className}&roll=${roll}`);
                const data = await response.json();
                
                if(data.error) {
                    alert("দুঃখিত! ফলাফল পাওয়া যায়নি। রোল ও শ্রেণী চেক করুন।");
                } else {
                    renderResult(data);
                    document.getElementById('landingPage').classList.add('hidden');
                    document.getElementById('resultPage').classList.remove('hidden');
                }
            } catch (err) {
                alert("সার্ভার ত্রুটি!");
            } finally {
                btnText.innerText = "ফলাফল দেখুন";
                loadingIcon.classList.add('hidden');
                searchBtn.disabled = false;
            }
        }

        function goBack() {
            document.getElementById('landingPage').classList.remove('hidden');
            document.getElementById('resultPage').classList.add('hidden');
            document.getElementById('rollInput').value = "";
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Logic: if value is number, 2 decimals. If text (A+, F), return text.
        function formatGradeOrGPA(val) {
            if (val === undefined || val === null || val === "" || val === "---") return "---";
            let strVal = val.toString().trim();
            
            // Check if it looks like a number
            if (!isNaN(parseFloat(strVal)) && isFinite(strVal)) {
                 return parseFloat(strVal).toFixed(2);
            }
            // Return as string otherwise
            return strVal;
        }

        function findVal(obj, keys) {
            if (!obj) return "---";
            const objKeys = Object.keys(obj);
            
            // Normalize: Normalize Unicode (NFC), remove spaces, lowercase
            const normalize = (s) => s.toString().normalize('NFC').replace(/\s+/g, '').toLowerCase();

            for (let k of keys) {
                let target = normalize(k);
                
                if (obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
                
                let foundKey = objKeys.find(key => normalize(key) === target);
                if (foundKey) return obj[foundKey];
            }
            
            // Special check for GPA partial match
            if (keys.some(k => k.toLowerCase().includes("gpa"))) {
                 let fallback = objKeys.find(k => normalize(k).includes("gpa"));
                 if(fallback) return obj[fallback];
            }

            return "---";
        }

        function renderResult(data) {
            const info = data.studentInfo;
            // Merge summary into info for unified searching
            const mergedData = { ...info, ...data.summary };
            const sum = data.summary;

            document.getElementById('st_name').innerText = findVal(info, ["Name", "নাম", "শিক্ষার্থীর নাম"]);
            document.getElementById('st_father').innerText = findVal(info, ["Father", "পিতার নাম", "পিতা"]);
            document.getElementById('st_mother').innerText = findVal(info, ["Mother", "মাতার নাম", "মাতা"]);
            document.getElementById('st_roll').innerText = findVal(info, ["Roll", "রোল", "রোল নম্বর"]);
            document.getElementById('st_class').innerText = document.getElementById('classSelect').selectedOptions[0].text;

            currentStudent = findVal(info, ["Name", "রোল ও নাম"]);

            let marksHtml = "";
            data.subjects.forEach(sub => {
                marksHtml += `<tr>
                    <td class="text-left font-bold text-emerald-900 pl-4">${sub.name}</td>
                    <td>${sub.marks}</td>
                    <td class="font-bold">${sub.lg}</td>
                    <td>${formatGradeOrGPA(sub.gp)}</td>
                </tr>`;
            });
            document.getElementById('marksBody').innerHTML = marksHtml;

            // Summary Mapping
            document.getElementById('sm_total').innerText = findVal(mergedData, ["মোট প্রাপ্ত নং", "Total", "Total Marks"]);
            
            // Average
            document.getElementById('sm_avg').innerText = formatGradeOrGPA(findVal(mergedData, ["গড়", "গড়", "Average", "Avg", "গড় নম্বর"]));
            
            // GPA (Uses mergedData to search everywhere)
            document.getElementById('sm_gpa').innerText = formatGradeOrGPA(findVal(mergedData, ["GPA", "G.P.A", "GradePointAverage", "জিপিএ"]));
            
            // Final Grade (Text or Number logic handled by formatGradeOrGPA)
            document.getElementById('sm_grade').innerText = formatGradeOrGPA(findVal(mergedData, ["Grade Point", "Grade", "Final Grade", "গ্রেড", "চূড়ান্ত গ্রেড"]));
            
            document.getElementById('sm_pos').innerText = findVal(mergedData, ["প্রাপ্তস্থান", "Position", "Merit Position", "মেধাক্রম"]);
            
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function downloadJPG() {
            const element = document.getElementById('captureArea');
            element.classList.add('a4-download-mode');
            
            html2canvas(element, { 
                scale: 2.5, 
                useCORS: true,
                backgroundColor: "#ffffff",
                width: 800,
                windowWidth: 800
            }).then(canvas => {
                const link = document.createElement('a');
                link.download = currentStudent + '.jpg';
                link.href = canvas.toDataURL("image/jpeg", 0.9);
                link.click();
                element.classList.remove('a4-download-mode');
            });
        }
    </script>
</body>
</html>
